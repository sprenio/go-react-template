server {
    listen 80 default_server;
    listen [::]:80 default_server;

    server_name _;   # tu i tak nie ma znaczenia, bo to default_server

    root /usr/share/nginx/html;
    index index.html;

    location ~* \.(css|js|png|jpg|jpeg|gif|svg|woff2?|ttf|eot|ico|html)$ {
      # --------------------------------
      # Development environment (no caching)
      # --------------------------------
      # Comment out this block in production
        expires 0;
        add_header Cache-Control "no-cache, must-revalidate" always;
      # --------------------------------
      # Production environment (long cache + public)
      # --------------------------------
      # Uncomment this block for production
      # expires 30d;
      # add_header Cache-Control "public" always;

        access_log off;
    }

    location ^~ /og/ {
        # Allow only standard HTTP methods
        if ($request_method !~ ^(GET|HEAD|OPTIONS)$) {
            return 405;
        }
        # Proxy headers
        proxy_http_version 1.1;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";  # Required for websockets
        proxy_set_header X-Request-Id $request_id;

        # Backend service
        proxy_pass http://blog-webserver:8080/og/;  # Use Docker service name

        proxy_redirect off;

        # Timeouts
        proxy_read_timeout    900s; # max time to wait for response from backend after request is sent
        proxy_send_timeout    300s; # max time to send request body to backend
        send_timeout          300s; # max time to wait for the client (browser) to receive data from Nginx
                                    # - If the client stops reading (slow/broken connection), Nginx closes after this time.
                                    # - Does not affect communication with backend (only client ↔ Nginx).
        proxy_connect_timeout 2s;   # Time allowed to establish a TCP connection to the backend.
                                    # - For local Docker containers on the same host/network, 1–2s is enough.
                                    # - Increase this value (e.g. 10–30s) only if the backend is remote
                                    #   or connections may be delayed (cloud services, slow DNS, firewalls).

        # Buffers (increase for large requests)
        proxy_buffer_size     256k;
        proxy_buffers         8 512k;
        proxy_busy_buffers_size 512k;
    }

    location ^~ /api/ {
        # Allow only standard HTTP methods
        if ($request_method !~ ^(GET|POST|PUT|DELETE|OPTIONS)$) {
            return 405;
        }

        # Proxy headers
        proxy_http_version 1.1;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";  # Required for websockets
        proxy_set_header X-Request-Id $request_id;

        # Backend service
        proxy_pass http://blog-webserver:8080/;  # Use Docker service name

        proxy_redirect off;

        # Timeouts
        proxy_read_timeout    900s; # max time to wait for response from backend after request is sent
        proxy_send_timeout    300s; # max time to send request body to backend
        send_timeout          300s; # max time to wait for the client (browser) to receive data from Nginx
                                    # - If the client stops reading (slow/broken connection), Nginx closes after this time.
                                    # - Does not affect communication with backend (only client ↔ Nginx).
        proxy_connect_timeout 2s;   # Time allowed to establish a TCP connection to the backend.
                                    # - For local Docker containers on the same host/network, 1–2s is enough.
                                    # - Increase this value (e.g. 10–30s) only if the backend is remote
                                    #   or connections may be delayed (cloud services, slow DNS, firewalls).

        # Buffers (increase for large requests)
        proxy_buffer_size     256k;
        proxy_buffers         8 512k;
        proxy_busy_buffers_size 512k;
    }

    location / {
        # Allow only standard HTTP methods
        if ($request_method !~ ^(GET|POST|PUT|DELETE|OPTIONS)$) {
            return 405;
        }

        if ($http_user_agent ~* (Slackbot|facebookexternalhit|Discordbot|Twitterbot) ) {
            rewrite ^/(?!og/)(.*)$ /og/$1 last;
        }


        try_files $uri $uri/ /index.html;
    }

    access_log /var/log/nginx/access_default.log main;
    error_log /var/log/nginx/error_default.log;
}
