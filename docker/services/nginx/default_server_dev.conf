server {
    listen 80 default_server;
    listen [::]:80 default_server;

    server_name _;   # tu i tak nie ma znaczenia, bo to default_server

    root /var/www/html;

    location ^~ /api/ {
        # Allow only standard HTTP methods
        if ($request_method !~ ^(GET|POST|PUT|DELETE|OPTIONS)$) {
            return 405;
        }

        # Proxy headers
        proxy_http_version 1.1;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";  # Required for websockets
        proxy_set_header X-Request-Id $request_id;

        # Backend service
        proxy_pass http://gr-webserver:8080/;  # Use Docker service name

        proxy_redirect off;

        # Timeouts
        proxy_read_timeout    900s; # max time to wait for response from backend after request is sent
        proxy_send_timeout    300s; # max time to send request body to backend
        send_timeout          300s; # max time to wait for the client (browser) to receive data from Nginx
                                    # - If the client stops reading (slow/broken connection), Nginx closes after this time.
                                    # - Does not affect communication with backend (only client ↔ Nginx).
        proxy_connect_timeout 2s;   # Time allowed to establish a TCP connection to the backend.
                                    # - For local Docker containers on the same host/network, 1–2s is enough.
                                    # - Increase this value (e.g. 10–30s) only if the backend is remote
                                    #   or connections may be delayed (cloud services, slow DNS, firewalls).

        # Buffers (increase for large requests)
        proxy_buffer_size     256k;
        proxy_buffers         8 512k;
        proxy_busy_buffers_size 512k;
    }

    location / {
        # Allow only standard HTTP methods
        if ($request_method !~ ^(GET|POST|PUT|DELETE|OPTIONS)$) {
            return 405;
        }

        # Proxy headers
        proxy_http_version 1.1;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";  # Required for websockets
        proxy_set_header X-Request-Id $request_id;

        # Backend service
        proxy_pass http://host.docker.internal:5174;
        #proxy_pass http://host.docker.internal:{TARGET_PORT}; # Use this if backend runs on host

        proxy_redirect off;

        # Timeouts
        proxy_read_timeout    900s; # max time to wait for response from backend after request is sent
        proxy_send_timeout    300s; # max time to send request body to backend
        send_timeout          300s; # max time to wait for the client (browser) to receive data from Nginx
                                    # - If the client stops reading (slow/broken connection), Nginx closes after this time.
                                    # - Does not affect communication with backend (only client ↔ Nginx).
        proxy_connect_timeout 2s;   # Time allowed to establish a TCP connection to the backend.
                                    # - For local Docker containers on the same host/network, 1–2s is enough.
                                    # - Increase this value (e.g. 10–30s) only if the backend is remote
                                    #   or connections may be delayed (cloud services, slow DNS, firewalls).

        # Buffers (increase for large requests)
        proxy_buffer_size     256k;
        proxy_buffers         8 512k;
        proxy_busy_buffers_size 512k;
    }

    access_log /var/log/nginx/access_default.log main;
    error_log /var/log/nginx/error_default.log;
}
server {
    server_name www.rabbitmq.gr.localhost;

    # --------------------
    # Development (HTTP)
    # --------------------
    include snippets/http-def.conf;         # Uncomment for dev/localhost

    client_max_body_size 50M;

    location / {
        # Allow only standard HTTP methods
        if ($request_method !~ ^(GET|POST|PUT|DELETE|OPTIONS)$) {
            return 405;
        }

        # Proxy headers
        proxy_http_version 1.1;
        proxy_set_header Host              $host;
        proxy_set_header X-Real-IP         $remote_addr;
        proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";  # Required for websockets
        proxy_set_header X-Request-Id $request_id;

        # Backend service
        proxy_pass http://budget-rabbitmq:15672;  # Use Docker service name
        #proxy_pass http://host.docker.internal:{TARGET_PORT}; # Use this if backend runs on host

        proxy_redirect off;
        #proxy_redirect http://host.docker.internal:{TARGET_PORT} http://$host;

        # Timeouts
        proxy_read_timeout    900s;
        proxy_connect_timeout 60s;
        proxy_send_timeout    300s;
        send_timeout          300s;

        # Buffers (increase for large requests)
        proxy_buffer_size     256k;
        proxy_buffers         8 512k;
        proxy_busy_buffers_size 512k;
    }